<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QR Maker — Frontend-only QR generator & scanner</title>

  <!-- Simple modern UI font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0f1724;
      --card:#0b1220;
      --muted:#9aa4b2;
      --accent:#60a5fa;
      --radius:12px;
    }
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
      background:linear-gradient(180deg,#081127 0%, #061025 100%);
      color:#e6eef8;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding:18px;
      box-sizing:border-box;
    }

    .app{
      max-width:1100px;
      margin:0 auto;
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:20px;
      align-items:start;
    }

    .card{
      background:rgba(255,255,255,0.03);
      border-radius:var(--radius);
      padding:16px;
      box-shadow: 0 6px 18px rgba(2,6,23,0.6), inset 0 1px 0 rgba(255,255,255,0.02);
      border:1px solid rgba(255,255,255,0.03);
    }

    .title{
      display:flex;
      gap:12px;
      align-items:center;
      margin-bottom:12px;
    }
    .title h1{font-size:18px;margin:0}
    .title p{margin:0;color:var(--muted);font-size:13px}

    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type="text"], textarea, select {
      width:100%;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.04);
      background:rgba(255,255,255,0.02);
      color:inherit;
      box-sizing:border-box;
      font-size:14px;
      outline:none;
    }
    textarea{resize:vertical;min-height:80px}

    .row{display:flex;gap:10px;align-items:center}
    .row.space{justify-content:space-between}
    .flex{flex:1}
    .small{font-size:13px;color:var(--muted)}
    .controls{display:flex;flex-direction:column;gap:12px}

    .color-input{display:flex;gap:8px;align-items:center}
    .color-input input[type="color"]{width:44px;height:36px;border-radius:8px;border:0;padding:0;background:none}
    .btn{
      background:linear-gradient(90deg,var(--accent),#2bb5ff);
      border:0;color:#062033;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer;
      box-shadow:0 6px 14px rgba(10,80,140,0.15)
    }
    .btn.secondary{
      background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);font-weight:600;
    }
    .btn.ghost{background:transparent;border:0;color:var(--muted)}
    .muted{color:var(--muted);font-size:13px}

    /* Preview area */
    .preview-wrap{
      display:flex;flex-direction:column;align-items:center;gap:12px;padding:18px;
    }
    #qr-preview{
      display:flex;align-items:center;justify-content:center;
      background:rgba(0,0,0,0.2);
      padding:20px;border-radius:12px;
      min-height:300px;width:100%;
    }

    .download-actions{display:flex;gap:8px;flex-wrap:wrap}

    /* scanning modal */
    .modal{
      position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.6);
      display:none;align-items:center;justify-content:center;padding:16px;z-index:2000;
    }
    .modal .modal-card{width:100%;max-width:720px;background:var(--card);padding:10px;border-radius:12px}
    .close-x{float:right;color:var(--muted);cursor:pointer;font-weight:700}

    footer.small-note{margin-top:14px;color:var(--muted);font-size:13px;text-align:center}

    /* responsive */
    @media (max-width:920px){
      .app{grid-template-columns:1fr; padding-bottom:40px;}
      #qr-preview{min-height:260px}
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- LEFT: controls -->
    <div class="card controls">
      <div class="title">
        <div>
          <h1>QR Maker — frontend-only</h1>
          <p class="small">Generate • Customize • Scan • Download (PNG / SVG)</p>
        </div>
      </div>

      <div>
        <label for="titleInput">Title (optional)</label>
        <input id="titleInput" type="text" placeholder="e.g. QR that'll work forever" value="QR that'll work forever" />
      </div>

      <div>
        <label for="textInput">Text / URL / Any content</label>
        <textarea id="textInput" placeholder="Paste or type the content you want inside the QR">https://example.com</textarea>
        <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
          <button id="generateBtn" class="btn">Generate</button>
          <button id="clearBtn" class="btn secondary">Clear</button>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
        <div>
          <label>QR Color</label>
          <div class="color-input">
            <input id="fgColor" type="color" value="#0b67ff" />
            <input id="fgInput" type="text" class="flex" value="#0b67ff" />
          </div>
        </div>
        <div>
          <label>Background</label>
          <div class="color-input">
            <input id="bgColor" type="color" value="#ffffff" />
            <input id="bgInput" type="text" class="flex" value="#ffffff" />
          </div>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
        <div>
          <label>Size (px)</label>
          <select id="sizeSelect">
            <option value="100">100</option>
            <option value="250">250</option>
            <option value="500" selected>500 (default)</option>
            <option value="1080">1080</option>
            <option value="1500">1500</option>
            <option value="2000">2000</option>
          </select>
        </div>
        <div>
          <label>Format</label>
          <div style="display:flex;gap:8px">
            <label class="small"><input type="radio" name="fmt" value="png" checked> PNG</label>
            <label class="small"><input type="radio" name="fmt" value="svg"> SVG</label>
          </div>
        </div>
      </div>

      <div style="display:flex;gap:8px;align-items:center">
        <button id="downloadBtn" class="btn">Download</button>
        <button id="scanBtn" class="btn secondary">Scan QR (camera)</button>
        <button id="copyBtn" class="btn ghost" title="Copy scanned or generated text">Copy text</button>
      </div>

      <div style="margin-top:8px">
        <label class="small">Error correction</label>
        <select id="ecSelect">
          <option value="L">L - Low</option>
          <option value="M" selected>M - Medium</option>
          <option value="Q">Q - Quartile</option>
          <option value="H">H - High</option>
        </select>
      </div>

      <div style="margin-top:8px">
        <label class="small">QR Style</label>
        <select id="styleSelect">
          <option value="squares">Classic squares</option>
          <option value="round">Rounded dots</option>
          <option value="dots">Dots</option>
        </select>
      </div>

      <div style="margin-top:10px" class="muted">
        Tip: paste a URL and hit Generate. Use the Scan button to open your camera and scan any QR. SVG downloads are vector (best for prints).
      </div>

      <footer class="small-note">Made for speed · Works offline after libraries load · Mobile-friendly</footer>
    </div>

    <!-- RIGHT: preview -->
    <div class="card preview-wrap">
      <div style="width:100%;display:flex;justify-content:space-between;align-items:center">
        <div>
          <div class="small">Preview</div>
        </div>
        <div class="small muted" id="previewInfo">500 × 500 • PNG</div>
      </div>

      <div id="qr-preview" class="card" style="width:100%;max-width:720px;">
        <!-- QR will be rendered here -->
        <div id="qr-holder" style="display:flex;flex-direction:column;align-items:center;gap:8px;">
          <div id="qr-canvas" style="background:transparent;border-radius:8px;padding:6px"></div>
          <div id="qr-title" class="muted" style="font-weight:600;font-size:14px"></div>
        </div>
      </div>

      <div class="download-actions" style="width:100%;justify-content:center;margin-top:6px">
        <button id="btnDownloadPreview" class="btn">Download Preview</button>
        <button id="btnExportSVG" class="btn secondary">Export SVG</button>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px;align-items:center;width:100%">
        <div class="small" style="flex:1">Last scan / current value:</div>
        <input id="scannedText" type="text" class="flex" placeholder="Scanned content will appear here" />
      </div>
    </div>
  </div>

  <!-- Modal for scanning -->
  <div id="scanModal" class="modal" aria-hidden="true">
    <div class="modal-card card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">Scan QR</div>
        <div class="close-x" id="closeScan">✕</div>
      </div>
      <div id="reader" style="margin-top:10px"></div>
      <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
        <select id="cameraSelect" style="flex:1"></select>
        <button id="startCam" class="btn">Start</button>
        <button id="stopCam" class="btn secondary">Stop</button>
      </div>
      <div style="margin-top:8px" class="small muted">Allow camera access when prompted. Tap a camera to select.</div>
    </div>
  </div>

  <!-- Libraries -->
  <!-- qr-code-styling: handles PNG/SVG output & customization -->
  <script src="https://cdn.jsdelivr.net/npm/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
  <!-- html5-qrcode: scanning with camera -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>

  <script>
    // Helper: query
    const $ = (sel, root=document) => root.querySelector(sel);

    // Elements
    const textInput = $('#textInput');
    const titleInput = $('#titleInput');
    const generateBtn = $('#generateBtn');
    const clearBtn = $('#clearBtn');
    const fgColor = $('#fgColor');
    const bgColor = $('#bgColor');
    const fgInput = $('#fgInput');
    const bgInput = $('#bgInput');
    const sizeSelect = $('#sizeSelect');
    const downloadBtn = $('#downloadBtn');
    const btnDownloadPreview = $('#btnDownloadPreview');
    const btnExportSVG = $('#btnExportSVG');
    const previewInfo = $('#previewInfo');
    const qrHolder = $('#qr-canvas');
    const qrTitleEl = $('#qr-title');
    const scannedTextEl = $('#scannedText');
    const copyBtn = $('#copyBtn');
    const scanBtn = $('#scanBtn');

    const ecSelect = $('#ecSelect');
    const styleSelect = $('#styleSelect');
    const scanModal = $('#scanModal');
    const closeScan = $('#closeScan');
    const cameraSelect = $('#cameraSelect');
    const startCam = $('#startCam');
    const stopCam = $('#stopCam');

    // default options
    const DEFAULT_SIZE = parseInt(sizeSelect.value || 500, 10);

    // map style to qr-code-styling options
    function shapeOptionsFor(style){
      if(style === 'round'){
        return {type: 'dots', data: null}; // fallback
      }
      return {};
    }

    // create QRCodeStyling instance (we recreate it on every generate to keep API simple)
    let qrCode = null;

    function buildQrObject(){
      const data = textInput.value || '';
      const fg = (fgInput.value || fgColor.value || '#0b67ff').trim();
      const bg = (bgInput.value || bgColor.value || '#ffffff').trim();
      const size = parseInt(sizeSelect.value,10) || DEFAULT_SIZE;
      const ecLevel = ecSelect.value || 'M';
      const style = styleSelect.value || 'squares';
      const qrOpts = {
        width: size,
        height: size,
        data: data,
        image: undefined,
        margin: 10,
        qrOptions: { typeNumber: 0, mode: 'Byte', errorCorrectionLevel: ecLevel },
        // draw options for styling
        dotsOptions: {
          color: fg,
          type: (style === 'round' || style === 'dots') ? 'rounded' : 'square'
        },
        cornersSquareOptions: {
          color: fg,
          type: (style === 'round') ? 'extra-rounded' : 'square'
        },
        backgroundOptions: {
          color: bg,
        }
      };
      return qrOpts;
    }

    // Render into preview
    async function generateQR(){
      const opts = buildQrObject();
      // clear holder
      qrHolder.innerHTML = '';
      qrTitleEl.textContent = titleInput.value || '';
      previewInfo.textContent = `${opts.width} × ${opts.height} • ${getSelectedFormat().toUpperCase()}`;

      // create instance
      qrCode = new QrCodeStyling(opts);

      // append
      qrCode.append(qrHolder);

      // small delay to ensure rendering if needed (but it's synchronous)
      // Update accessible alt or title
      qrHolder.setAttribute('aria-label', 'QR preview');

      return qrCode;
    }

    function getSelectedFormat(){
      return document.querySelector('input[name="fmt"]:checked').value || 'png';
    }

    // download blob (png or svg)
    async function downloadCurrent(){
      if(!qrCode){
        await generateQR();
      }
      const fmt = getSelectedFormat();
      const name = (titleInput.value || 'qr-code').replace(/\s+/g,'-').toLowerCase();
      const size = parseInt(sizeSelect.value,10) || DEFAULT_SIZE;

      // qrCode.getRawData returns a Promise<Blob>
      try{
        const blob = await qrCode.getRawData(fmt === 'svg' ? 'svg' : 'png');
        // for PNG we might want to ensure requested size: qrCode was created with width/height accordingly
        const a = document.createElement('a');
        const url = URL.createObjectURL(blob);
        a.href = url;
        a.download = `${name}-${size}x${size}.${fmt}`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(()=>URL.revokeObjectURL(url), 1500);
      }catch(err){
        console.error('Download failed', err);
        alert('Could not export file. Check console for details.');
      }
    }

    // Download preview (alias)
    btnDownloadPreview.addEventListener('click', downloadCurrent);
    downloadBtn.addEventListener('click', downloadCurrent);

    // Export SVG quick button (forces svg)
    btnExportSVG.addEventListener('click', async ()=>{
      // set svg radio
      document.querySelector('input[name="fmt"][value="svg"]').checked = true;
      await downloadCurrent();
    });

    // Generate on click
    generateBtn.addEventListener('click', async ()=>{
      await generateQR();
    });

    clearBtn.addEventListener('click', ()=>{
      textInput.value = '';
      scannedTextEl.value = '';
      qrHolder.innerHTML = '';
      qrTitleEl.textContent = '';
      qrCode = null;
    });

    // sync color hex text boxes with color inputs
    fgColor.addEventListener('input', ()=>{ fgInput.value = fgColor.value; });
    bgColor.addEventListener('input', ()=>{ bgInput.value = bgColor.value; });
    fgInput.addEventListener('change', ()=>{ fgColor.value = fgInput.value; });
    bgInput.addEventListener('change', ()=>{ bgColor.value = bgInput.value; });

    // update preview info when size or format changes
    sizeSelect.addEventListener('change', ()=> {
      previewInfo.textContent = `${sizeSelect.value} × ${sizeSelect.value} • ${getSelectedFormat().toUpperCase()}`;
      // live regenerate for instant preview
      generateQR();
    });
    document.querySelectorAll('input[name="fmt"]').forEach(r=>{
      r.addEventListener('change', ()=> previewInfo.textContent = `${sizeSelect.value} × ${sizeSelect.value} • ${getSelectedFormat().toUpperCase()}`);
    });

    // copy scanned or current text
    copyBtn.addEventListener('click', async ()=>{
      const v = scannedTextEl.value || textInput.value;
      if(!v) return alert('No text to copy');
      try{
        await navigator.clipboard.writeText(v);
        copyBtn.textContent = 'Copied ✓';
        setTimeout(()=>copyBtn.textContent = 'Copy text',1100);
      }catch(e){
        alert('Could not copy — permission denied?');
      }
    });

    // Keep preview in sync when user edits settings quickly (live)
    ['fgInput','bgInput','ecSelect','styleSelect','titleInput'].forEach(id=>{
      (id === 'fgInput' ? fgInput : id === 'bgInput' ? bgInput : (id === 'ecSelect' ? ecSelect : id === 'styleSelect' ? styleSelect : titleInput))
      .addEventListener('input', ()=> generateQR());
    });

    // initial generate
    generateQR();

    // --------------------
    // Scanning logic using html5-qrcode
    // --------------------
    let html5QrScanner = null;
    let scanning = false;

    async function listCamerasToSelect(){
      try{
        const devices = await Html5Qrcode.getCameras();
        cameraSelect.innerHTML = '';
        devices.forEach(dev=>{
          const opt = document.createElement('option');
          opt.value = dev.id;
          opt.textContent = dev.label || dev.id;
          cameraSelect.appendChild(opt);
        });
      }catch(err){
        // no cameras or permission problem
        cameraSelect.innerHTML = '<option value="">No camera found</option>';
      }
    }

    function openScanModal(){
      scanModal.style.display = 'flex';
      scanModal.setAttribute('aria-hidden','false');
      listCamerasToSelect();
    }
    function closeScanModal(){
      scanModal.style.display = 'none';
      scanModal.setAttribute('aria-hidden','true');
      stopScanning();
    }

    scanBtn.addEventListener('click', openScanModal);
    closeScan.addEventListener('click', closeScanModal);

    // handle outside click to close
    scanModal.addEventListener('click', (ev)=>{
      if(ev.target === scanModal) closeScanModal();
    });

    startCam.addEventListener('click', async ()=>{
      const cameraId = cameraSelect.value;
      const readerId = "reader";
      if(scanning){
        return;
      }
      try{
        html5QrScanner = new Html5Qrcode(readerId, /* verbose= */ false);
        scanning = true;
        await html5QrScanner.start(
          cameraId || { facingMode: "environment" },
          {
            fps: 10,
            qrbox: function(viewfinderWidth, viewfinderHeight){
              // square qrbox that fits inside
              const smaller = Math.min(viewfinderWidth, viewfinderHeight);
              return {width: Math.min(smaller, 360), height: Math.min(smaller, 360)};
            }
          },
          (decodedText, decodedResult) => {
            // success callback
            scannedTextEl.value = decodedText;
            textInput.value = decodedText;
            generateQR(); // regenerate with scanned content
            // optionally auto-stop scanning after detection:
            // stopScanning();
          },
          (errorMessage) => {
            // parse errors - ignore
          }
        );
      }catch(err){
        console.error('Start camera failed', err);
        alert('Could not start camera — check permissions and HTTPS.');
        scanning = false;
      }
    });

    stopCam.addEventListener('click', stopScanning);

    async function stopScanning(){
      if(html5QrScanner && scanning){
        try{
          await html5QrScanner.stop();
        }catch(e){}
        html5QrScanner.clear();
      }
      scanning = false;
      html5QrScanner = null;
      const reader = $('#reader');
      if(reader) reader.innerHTML = '';
    }

    // On page load list devices
    listCamerasToSelect().catch(()=>{});

    // Accessibility: press Enter on text to generate
    textInput.addEventListener('keydown', (e)=> { if(e.key === 'Enter' && (e.metaKey || e.ctrlKey)) generateQR(); });

    // Show scanned result also in preview field when changed manually
    scannedTextEl.addEventListener('change', ()=> {
      textInput.value = scannedTextEl.value;
      generateQR();
    });

    // When page hides, stop camera
    document.addEventListener('visibilitychange', ()=> {
      if(document.hidden) stopScanning();
    });

    // Prevent long content from exploding QR error level wise - warn user if length big
    function warnIfLarge(){
      if((textInput.value||'').length > 2000){
        alert('Content is very long — QR may fail to encode at small sizes. Use larger size or shorter text.');
      }
    }
    textInput.addEventListener('blur', warnIfLarge);

    // Make sure initial preview downloads at default 500x500
    // Preselect 500 in the UI (already done by markup)

    // Basic keyboard/mobile tweaks: focus inputs on touch
    // (No further handlers needed)
  </script>
</body>
</html>
